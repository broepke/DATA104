---
title: "Midterm 1"
author: "Brian Roepke"
date: "October 30, 2020"
output:
  html_document:
    df_print: tibble
---
# Data 104 Midterm
The sample dataset contains obfuscated Google Analytics 360 data from the Google Merchandise Store, a real ecommerce store that sells Google branded merchandise. The dataset was pulled using Googleâ€™s BigQuery.

The following are the definitions of the fields from Google Analytics:

 * **date** - session in YYYYMMDD format
 * **userID** - (eg: fullVisitorId) ; The unique visitor ID (also known as client ID).
 * **sessionID** - (eg: visitId); Identifier for this session. Only unique to the user. For a completely
unique ID, you use a combination of fullVisitorId and visitId.
 * **session** - (eg: visitNumber); The session number for this user. If this is the first session, then this
is set to 1.
 * **pageviews** - Total number of pageviews within the session.
 * **newVisits** - Total number of new users in session (for convenience). If this is the first visit, this value is 1, otherwise it is null.
 * **transactions** - Total number of ecommerce transactions within the session.
 * **visits** - This value is 1 for sessions with interaction events. The value is null if there are no
interaction events in the session
 * **totalTransactionRevenue** - Total transaction revenue, expressed as the value passed to
Analytics multiplied by 10^6 (e.g., 2.40 would be given as 2400000)
 * **browser** - browser used (e.g., "Chrome" or "Firefox").
 * **deviceCategory** - Type of device (Mobile, Tablet, Desktop).
 * **country** - Country from which sessions originated
 * **region** - Region from which sessions originate. In the U.S., a region is a state, such as New
York.
 * **hitNumber** - Sequence of pages that a user looked at within one session. (eg: the sequenced hit
number). For the first hit of each session, this is set to 1.
 * **pagePath** - URL path of the page.

```{r}
# plotting and pipes - tidyverse
library(ggplot2)
library(dplyr, warn.conflicts = FALSE)
options(dplyr.summarise.inform = FALSE) # Suppress summarise info
suppressPackageStartupMessages(library(tidyverse)) # suppress startup message
library(lubridate, warn.conflicts = FALSE)
library(corrplot)

# don't use scientific notation (for the userID field)
options(scipen=999)
```




```{r}
ga <- read.csv("bq-results.csv", colClasses=c("userID"="character"))
```


```{r}
ga$date <- as.character(ga$date)
ga$date <- as.Date(ga$date, "%Y%m%d")
ga$browser <- as.factor(ga$browser)
ga$deviceCategory <- as.factor(ga$deviceCategory)
ga$country <- as.factor(ga$country)
ga$region <- as.factor(ga$region)
# ga$userID <- as.character(ga$userID)

# Rescale totalTransactionRevenue by dividing by 1 million
ga$totalTransactionRevenue <- ga$totalTransactionRevenue / 1e+6

# Columns to remove - Not needed for the analysis.  Removing these will make the data a little simpler
ga$hitNumber <- NULL
ga$pagePath <- NULL

# Clean up some of the values to more useful settings
ga$region[ga$region == "not available in demo dataset"] <- NA
ga$region[ga$region == "(not set)"] <- NA
ga$transactions[is.na(ga$transactions)] <- 0
# ga$totalTransactionRevenue[is.na(ga$totalTransactionRevenue)] <- 0

str(ga)
```


```{r}
head(ga)
tail(ga)
```

```{r}
ga %>%
  distinct() %>%
  select(date, session, pageviews, transactions,
         totalTransactionRevenue, browser, 
         deviceCategory, country, region) %>%
  summary()
```

## EDA for Single UserID and single SessionID

```{r}
ga %>%
  filter(userID == "0014262055593378383" & sessionID == 1499123682) %>%
  head(n = 50)
```
Here we can see that a single user's activity, with 30 pageviews, results in 30 rows in the data.  Each of these rows contain the same information with the exception of `hitNumber` and `pagePath` (which have been dropped from the dataset already, since they will not be used in the analysis,)


### Distinct User Activity

Remove all the duplicate rows, so there is a single entry for each user session

```{r}
ga %>%
  filter(userID == "0014262055593378383") %>%
  distinct() %>%
  select(date, session, pageviews, transactions,
         totalTransactionRevenue, browser, 
         deviceCategory, country, region) %>%
  summary()

```

For this `UserID`.  We can see thy have `5` visits today (both `session` count `4 - 8`, and the Factor `country` and `region` showing `5`).  we see that out of the `5` visions, they made `2` transactions, and have a mean transaction amount of `37.40`. 


## Activity by Location Information

```{r}
ga %>%
  distinct() %>%
  count(country, sort = TRUE)  %>%
  mutate(country = reorder(country, n))  %>%
  slice_max(order_by=country, n = 10) %>% 

  # Create a Colum chart of top 10
  ggplot(aes(x = country, y = n)) + 
  geom_col() + 
  coord_flip() + 
  theme_minimal() +
  labs(x = "Count",
       y = "Country",
       title = "Top Locations of Users")
```

```{r}
ga %>%
  distinct() %>%
  filter(transactions > 0) %>%
  count(country, sort = TRUE)  %>%
  mutate(country = reorder(country, n))  %>%
  slice_max(order_by=country, n = 10) %>% 

  # Create a Colum chart of top 10
  ggplot(aes(x = country, y = n)) + 
  geom_col() + 
  coord_flip() + 
  theme_minimal() +
  labs(x = "Count",
       y = "Country",
       title = "Top Countries of Users Who Made a Transaction")
```


```{r}
ga %>%
  distinct() %>%
  count(region, sort = TRUE)  %>%
  mutate(region = reorder(region, n))  %>%
  slice_max(order_by=region, n = 10) %>% 

  # Create a Colum chart of top 10
  ggplot(aes(x = region, y = n)) + 
  geom_col() + 
  coord_flip() + 
  theme_minimal() +
  labs(x = "Count",
       y = "Country",
       title = "Top Regions of Users")
```


## EDA of Transactions

```{r}
ga %>%
  distinct() %>%
  filter(transactions > 0) %>%
  ggplot(aes(x = totalTransactionRevenue)) + 
  geom_density(color = "red",fill = "salmon", alpha=0.5) + 
  theme_minimal() +
  labs(x = "Revenue",
       y = "Count",
       title = "Transaction Revenue")
```

```{r}
ga %>%
  distinct() %>%
  filter(transactions > 0) %>%
  ggplot(aes(x = pageviews, y = totalTransactionRevenue)) + 
  geom_point(alpha = 0.2) + 
  theme_minimal() +
  labs(x = "Pageviews",
       y = "Revenue",
       title = "Correlation of Pageviews vs. Revenue")
```
There are two outlier transactions that stick out in terms of revenue.  Without removing them, the scatter plot is hard to interpret.  First let's take a look at what those transactions are, and second, we can pair down the data a little bit. 

```{r}
ga %>%
  filter(totalTransactionRevenue > 10000) %>%
  distinct() %>%
  head()
```

Interestingly these two transactions from from the very same user.  it's worth investigating how many visits they have done, and additional transactions

```{r}
ga %>%
  filter(userID == "9417857471295131045") %>%
  distinct() %>%
  arrange(desc(pageviews)) %>%
  head(n = 20)

ga %>%
  filter(transactions > 0 & userID == "9417857471295131045") %>%
  distinct() %>%
  group_by(userID) %>%
  summarise(total = sum(totalTransactionRevenue))

```
This user (`9417857471295131045`) had `9` transactions over the month. and a total of `41810.85`.


```{r}
ga %>%
  distinct() %>%
  filter(transactions > 0 & totalTransactionRevenue < 2000 & pageviews < 100) %>%
  ggplot(aes(x = pageviews, y = totalTransactionRevenue)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "lm", se = TRUE, formula = y ~ x) + 
  theme_minimal() +
  labs(x = "Pageviews",
       y = "Revenue",
       title = "Correlation of Pageviews vs. Revenue")
```

We can see with these lower transactions a slight positive correlation. 


```{r}
ga %>%
  distinct() %>%
  filter(transactions > 0 & totalTransactionRevenue < 2000) %>%
    ggplot(aes(totalTransactionRevenue, color = country)) +
    geom_boxplot() +
    labs(title = "Revenue Distribution by Country",
         x = "Revenue",
         y = NULL) +
    theme_minimal() +
    theme(
      legend.title = element_blank(),
      legend.position = "right",
      plot.title = element_text(face = "bold"))
```



```{r}
ga_corr <- ga %>%
    select_if(is.numeric)

corr <- round(cor(ga_corr), 2)
corr
```

```{r}
corrplot(corr, method="color")
```






## Aggregate a View for User Activity Per Session


```{r}
ga %>%
  filter(transactions > 0 & userID == "0014262055593378383") %>%
  group_by(userID) %>%
  distinct() %>%
  summarise(pg_views = sum(pageviews), revenue = sum(totalTransactionRevenue))
```



### What days of the month produced the most revenue

```{r}
ga %>%
  filter(transactions > 0) %>%
  distinct() %>%
  ggplot(aes(y = totalTransactionRevenue, x = date)) + 
  geom_col()
```


### How many Users had more at least one transaction.

Determine how many users there are, and how many total 

```{r}
ga %>%
  filter(transactions > 0) %>%
  distinct(userID) %>%
  summarise(userID = n())

```

There are `1,000` unique (distinct) users in this dataset that completed at least one transaction.  These users could have completed more than one. 

# Mid Term Questions
Make sure to show intermediary data frames / aggregations / calculations that help answer the questions. Some hints have been included to assist you but you should apply the tools / knowledge gained up to this point.

## Question #1 
What was the average number of product `pageviews` for users **who did** make a purchase?

**Note:** *General calculation: SUM(total_pagesviews_per_user) / COUNT(users)*


```{r}
ga %>%
  filter(transactions > 0) %>%
  distinct() %>%
  summarise(avg_pageviews = (sum(pageviews) / n_distinct(userID)))
```

What we find is that users have an average of `28` page views that make a transaction. 

**Note:** *This calculation represent distinct users, which takes into account users that have made more than one transaction.  for example, if there was a user that had 2 sessions which resulted in transactions, they are not counted as two users, they are counted as a single person.* 

**Validation**

The following is a simple validation tool for checking two user's combined avg page views.

```{r}
# Use the following to test for 1 or 2 users
ga %>%
  filter(transactions > 0 & (userID == "0006911334202687206" | userID == "0014262055593378383")) %>%
  distinct() %>%
  summarise(avg_pageviews = (sum(pageviews) / n_distinct(userID)))
```



## Question #2

What was the average number of product `pageviews` for users who **did not** make a purchase?

```{r}
ga %>%
  filter(transactions > 0) %>%
  distinct() %>%
  summarise(avg_pageviews = (sum(pageviews) / n_distinct(userID)))
```

The average number of pageviews for users that did not page a purchase is `4.22`.


**Note:** *This calculation represent distinct users, which takes into account users that have made more than one visit to the site that didn't result in a transaction.  This doesn't mean the user didn't eventually make a transaction in another session.*


## Question #3 
What was the average total transactions per user that made a purchase?

**Note:** *General calculation: SUM (total_transactions_per_user) / COUNT(userID)*

```{r}
ga %>%
  filter(transactions > 0) %>%
  distinct() %>%
  summarise(average_transaction = (sum(totalTransactionRevenue) / n_distinct(userID)))
```


## Question #4
What is the average amount of money spent per session? Here per session is the total of â€˜visitsâ€™ by user.

**Note:** *General calculation: SUM(total_transactionrevenue_per_user) / SUM(total_visits_per_user)*

### View 1: Average Revenue per Site All Site Visitors
The following is showing the average revenue generated on the site for all user visits for the month, regardless of if they made a transaction.  `2.281443` per user that visits. 

```{r}
sum_visits <- ga %>%
  distinct() %>%
  summarise(sum(visits))

sum_rev <- ga %>%
  filter(transactions > 0) %>%
  distinct() %>%
  summarise(sum(totalTransactionRevenue))

sum_rev / sum_visits
```

### View 2: Average Revenue per Customer 
The next version is average revenue for all users that made a purchase. `157.9421` per user.

```{r}
ga %>%
  filter(transactions > 0) %>%
  distinct() %>%
  summarise(average_spent_per_visit = (sum(totalTransactionRevenue) / sum(visits)))
```


## Question #5
What is the total number of transactions generated per browser type ? Results should be in tabular form that shows the aggregated transactions by browser, including those that resulted in 0 transactions.

```{r}
ga %>%
  distinct() %>%
  dplyr::group_by(browser) %>%
  dplyr::summarise(trans = sum(transactions)) %>%
  arrange(desc(trans))
```



# Regression Analysis

```{r}
names(ga)
```

### Logistic Regression to Predict Converstion

Convert the transaction field into a binary value in a new Data Frame

```{r}
summary(ga$transactions)
ga_log <- ga
ga_log$transactions[ga_log$transactions > 0] = 1
summary(ga_log$transactions)
```


```{r}
ga_glm <- ga_log %>%
  distinct()

model <- glm(formula = transactions ~ region, data = ga_glm)

model.tab <-  coef(summary(model))
model.tab[, "Estimate"] <- exp(coef(model))
model.tab
```



**Note**: https://www.displayr.com/how-to-interpret-logistic-regression-coefficients/

## Multiple Linear Regression to predict Transaction Revenue

Looking for a simple linear model to predict revenue, page views

```{r}
ga_lm <- ga %>%
  distinct()

fit <- lm(formula = totalTransactionRevenue ~ pageviews + session + region, data = ga_lm)

summary(fit)
```

Using `Pageviews`, `Sessions`, and `Region`, we have three significant values in our model with an `R^2`  of `0.1172`, telling us that `11.7%` of the variance in Total Transaction Revenue can be described by these two values. This was the strongest predictor found within the supplied data. 

