---
title: "Midterm 1"
author: "Brian Roepke"
date: "October 30, 2020"
output:
  html_document:
    df_print: tibble
---
# Data 104 Midterm

```{r}
# plotting and pipes - tidyverse
library(ggplot2)
library(dplyr, warn.conflicts = FALSE)
options(dplyr.summarise.inform = FALSE) # Suppress summarise info

# text mining library
suppressPackageStartupMessages(library(tidyverse)) # suppress startup message

# date/time libaray
library(lubridate, warn.conflicts = FALSE)

# don't use scientific notation (for the userID field)
options(scipen=999)
```




```{r}
ga <- read.csv("bq-results.csv")
```


```{r}
ga$date <- as.character(ga$date)
ga$date <- as.Date(ga$date, "%Y%m%d")
ga$browser <- as.factor(ga$browser)
ga$deviceCategory <- as.factor(ga$deviceCategory)
ga$country <- as.factor(ga$country)
ga$region <- as.factor(ga$region)
# ga$userID <- as.character(ga$userID)

# Rescale totalTransactionRevenue by dividing by 1 million
ga$totalTransactionRevenue <- ga$totalTransactionRevenue / 1e+6

# Columns to remove - Not needed for the analysis.  Removing these will make the data a little simpler
ga$hitNumber <- NULL
ga$pagePath <- NULL

str(ga)
```


```{r}
select(ga, date, session, pageviews, transactions,
       totalTransactionRevenue, browser, 
       deviceCategory, country, region) %>%
  summary()
```

```{r}
head(ga)
tail(ga)
```


## Aggregate a View for User Activity Per Session


```{r}
ga %>%
  filter(transactions > 0 & userID == 14262055593378384) %>%
  group_by(userID) %>%
  distinct() %>%
  summarise(pg_views = sum(pageviews), revenue = sum(totalTransactionRevenue))
```



### What days of the month produced the most revenue

```{r}
ga %>%
  filter(transactions > 0) %>%
  ggplot(aes(y = totalTransactionRevenue, x = date)) + 
  geom_col()
```


### How many Users had more at least one transaction.

Determine how many users there are, and how many total 

```{r}
users_w_trans <- ga %>%
  filter(transactions > 0) %>%
  group_by(userID) %>%
  distinct() %>%
  summarise(transactions = sum(transactions)) %>%
  arrange(desc(transactions))

users_w_trans

#set a variable for the number of users
total_users_w_trans <- nrow(users_w_trans)
```
### Filter by a single user

Simple tool to check a user's data

```{r}
ga %>%
  filter(userID == 9417857471295131648) %>%
  head(n=500)
```





## Question #1 
What was the average number of product `pageviews` for users **who did** make a purchase?

**Note:** *General calculation: SUM(total_pagesviews_per_user) / COUNT(users)*


```{r}
ga %>%
  filter(transactions > 0) %>%
  distinct() %>%
  summarise(avg_pageviews = (sum(pageviews) / n_distinct(userID)))
```

What we find is that users have an average of `28` pageviews that make a transaction. 

**Note:** *This calculation represent distinct users, which takes into account users that have made more than one transaction.  for example, if there was a user that had 2 sessions which resulted in transactions, they are not counted as two users, they are counted as a single person.* 

#### Validation

The following is a simple validation tool for 

```{r}
# Use the following to test for 1 or 2 users
ga %>%
  filter(transactions > 0 & (userID == 6911334202687206 | userID == 14262055593378384)) %>%
  distinct() %>%
  summarise(avg_pageviews = (sum(pageviews) / n_distinct(userID)))
```



## Question #2

What was the average number of product `pageviews` for users who **did not** make a purchase?

```{r}
ga %>%
  filter(is.na(transactions)) %>%
  distinct() %>%
  summarise(avg_pageviews = (sum(pageviews) / n_distinct(userID)))
```

The average number of pageviews for users that did not page a purchase is `4.22`.


**Note:** *This calculation represent distinct users, which takes into account users that have made more than one visit to the site that didn't result in a transaction.  This doesn't mean the user didn't eventually make a transaction in another session.*


## Question #3 
What was the average total transactions per user that made a purchase?

**Note:** *General calculation: SUM (total_transactions_per_user) / COUNT(userID)*

```{r}
ga %>%
  filter(transactions > 0) %>%
  distinct() %>%
  summarise(average_transaction = (sum(totalTransactionRevenue) / n_distinct(userID)))
```


## Question #4
What is the average amount of money spent per session? Here per session is the total of ‘visits’ by user.

**Note:** *General calculation: SUM(total_transactionrevenue_per_user) / SUM(total_visits_per_user)*

## Question #5
What is the total number of transactions generated per browser type ? Results should be in tabular form that shows the aggregated transactions by browser, including those that resulted in 0 transactions.


## Extra Credit

Create a model:
 * Linear Regression - continuous outcome variable
 * Logistic Regression - binary outcome variable;
   * Ex: predicting conversion. Eg: converted = transactions >= 1 is either True (1) or False (0)

